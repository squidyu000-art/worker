index.html

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹å¸³æœ¬ 2026</title>
    <style>
        :root {
            --blue: #007aff; --red: #ff3b30; --green: #34c759; --gray: #8e8e93;
            --bg: #f0f2f5; --card: #ffffff; --date: #333333; --week: #888888;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); margin: 0; padding-bottom: 70px; color: #1c1c1e; }
        
        /* å°èˆªåˆ— */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 65px; background: rgba(255,255,255,0.9); display: flex; border-top: 1px solid #ddd; z-index: 1000; backdrop-filter: blur(10px); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--gray); font-size: 12px; }
        .nav-item.active { color: var(--blue); font-weight: bold; }
        .nav-item i { font-size: 22px; margin-bottom: 2px; }

        /* å…§å®¹å€ */
        .page { display: none; padding: 15px; max-width: 600px; margin: auto; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å¡ç‰‡èˆ‡å…ƒä»¶ */
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .btn { border: none; border-radius: 8px; padding: 10px 15px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-red { background: var(--red); color: white; }
        .full-width { width: 100%; margin-top: 10px; }
        .input-f { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin: 8px 0; font-size: 16px; }
        
        /* æ—¥æ›†æ¨£å¼ */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .week-labels { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; margin-bottom: 5px; }
        .day-card { background: white; aspect-ratio: 1/1.2; border-radius: 6px; padding: 4px; font-size: 12px; overflow: hidden; border: 1px solid #eee; }
        .site-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; color: white; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* å½ˆçª— */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:2000; padding:20px; }
        .modal-content { background:white; border-radius:15px; width:100%; max-width:400px; padding:20px; max-height:90vh; overflow-y:auto; }
        .row-between { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
        .gas-locked { background: #e9ecef; color: #6c757d; }
    </style>
</head>
<body>

<div id="tab-cal" class="page active">
    <div class="cal-header">
        <button class="btn" onclick="changeMonth(-1)">â—€</button>
        <h2 id="monthTitle">2026å¹´ 1æœˆ</h2>
        <button class="btn" onclick="changeMonth(1)">â–¶</button>
    </div>
    <div class="week-labels" id="weekLabels">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
    </div>
    <div class="cal-grid" id="calendarGrid"></div>
</div>

<div id="tab-worker" class="page">
    <div class="card">
        <input type="text" id="workerSearch" class="input-f" placeholder="ğŸ” æœå°‹å¸«å‚…å§“å..." oninput="renderWorkerList()">
        <input type="date" id="dateSearch" class="input-f" onchange="renderWorkerList()">
        <div class="row-between">
            <h3 id="payStatusLabel" style="color:var(--green)"></h3>
            <button class="btn btn-blue" onclick="openMultiExtra()">ğŸ’° å¤šäººé›œè²»</button>
        </div>
    </div>
    <div id="workerList"></div>
    <div class="card" style="position: sticky; bottom: 80px; background: #333; color: white;" onclick="openPaymentModal()">
        <div class="row-between">
            <b>æœ¬æœˆç¸½çµç®—ï¼š</b>
            <b id="totalExp" style="font-size: 20px;">$0</b>
        </div>
    </div>
    <button class="btn btn-blue full-width" onclick="openWorkerModal(null)">+ æ–°å¢å¸«å‚…æª”æ¡ˆ</button>
</div>

<div id="tab-set" class="page">
    <div class="card">
        <h3>â˜ï¸ é›²ç«¯åŒæ­¥è¨­å®š</h3>
        <p style="font-size: 13px; color: #666;">è²¼ä¸Š Google GAS ç¶²å€å¾Œé–å®šï¼Œé–‹å•Ÿå¾Œè‡ªå‹•åŒæ­¥ã€‚</p>
        <input type="text" id="gasUrlInp" class="input-f" placeholder="https://script.google.com/macros/s/...">
        <div class="row-between">
            <b>é–å®šç¶²å€ (é–‹å•Ÿè¨˜æ†¶åŠŸèƒ½)</b>
            <input type="checkbox" id="gasLock" onchange="toggleGasLock()" style="transform: scale(1.5);">
        </div>
    </div>
    <div class="card">
        <h3>ğŸ¨ ä»‹é¢è‡ªå®šç¾©</h3>
        <div class="row-between">èƒŒæ™¯é¡è‰² <input type="color" onchange="updateUI('bg', this.value)"></div>
        <div class="row-between">æ—¥æ›†æ—¥æœŸé¡è‰² <input type="color" onchange="updateUI('date', this.value)"></div>
        <div class="row-between">æ˜ŸæœŸæ¨™ç±¤é¡è‰² <input type="color" onchange="updateUI('week', this.value)"></div>
    </div>
    <button class="btn btn-red full-width" style="margin-top:50px; opacity:0.5" onclick="masterReset()">âš ï¸ é‡è¨­æ‰€æœ‰è³‡æ–™</button>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="switchPage('cal', this)"><i>ğŸ“…</i><span>æ—¥æ›†</span></div>
    <div class="nav-item" onclick="switchPage('worker', this)"><i>ğŸ‘¥</i><span>å¸«å‚…è–ªè³‡</span></div>
    <div class="nav-item" onclick="switchPage('set', this)"><i>âš™ï¸</i><span>è¨­å®š</span></div>
</nav>

<div class="modal-overlay" id="modalOverlay" onclick="if(event.target==this)closeModal()">
    <div class="modal-content" id="modalBody"></div>
</div>

<script>
let db = {
  workers: [], sites: [], extras: [], payments: {},
  ui: { bg: '#f0f2f5', date: '#333333', week: '#888888' }
};
let curMonth = new Date(2026, 0, 1);
let gasUrl = "";

// --- åˆå§‹è¼‰å…¥ ---
window.onload = async () => {
    const urlParams = new URLSearchParams(window.location.search);
    gasUrl = urlParams.get('gas') || localStorage.getItem('CONSTR_GAS_2026') || "";

    if (gasUrl) {
        document.getElementById('gasUrlInp').value = gasUrl;
        document.getElementById('gasUrlInp').disabled = true;
        document.getElementById('gasLock').checked = true;
        localStorage.setItem('CONSTR_GAS_2026', gasUrl);
        await fetchCloud();
    }
    applyUI(); renderAll();
};

// --- æ ¸å¿ƒï¼šç¶²å€é–å®šèˆ‡è·³è½‰ (GitHub Pages å°ˆç”¨ç‰ˆ) ---
function toggleGasLock() {
    const isLocked = document.getElementById('gasLock').checked;
    const inputEl = document.getElementById('gasUrlInp');
    const rawUrl = inputEl.value.trim();

    if (isLocked) {
        if (!rawUrl.startsWith('http')) { alert("è«‹è²¼ä¸Šæ­£ç¢ºç¶²å€"); document.getElementById('gasLock').checked = false; return; }
        localStorage.setItem('CONSTR_GAS_2026', rawUrl);
        const finalUrl = window.location.href.split('?')[0] + "?gas=" + encodeURIComponent(rawUrl);
        
        if (confirm("ç¶²å€å³å°‡é‡å°å‘ä»¥å®Œæˆè¨˜æ†¶é–å®šã€‚\n\nè¼‰å…¥å¾Œï¼Œè«‹é»æ“Š Chromeã€æ–°å¢è‡³ä¸»ç•«é¢ã€ã€‚")) {
            window.location.href = finalUrl;
        }
    } else {
        if (confirm("è§£é–å°‡ç§»é™¤è¨˜æ†¶ï¼Œç¢ºå®šå—ï¼Ÿ")) {
            localStorage.removeItem('CONSTR_GAS_2026');
            window.location.href = window.location.href.split('?')[0];
        } else { document.getElementById('gasLock').checked = true; }
    }
}

// --- é›²ç«¯èˆ‡æ¸²æŸ“ ---
async function fetchCloud() {
    if (!gasUrl) return;
    try {
        const res = await fetch(gasUrl);
        const data = await res.json();
        if (data && data.workers) { db = data; applyUI(); renderAll(); }
    } catch (e) { console.warn("Sync Read Fail"); }
}
async function syncCloud() {
    if (!gasUrl) return;
    try { await fetch(gasUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(db) }); } catch (e) {}
}

function renderAll() { renderCalendar(); renderWorkerList(); }
function switchPage(p, el) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
    document.getElementById('tab-'+p).classList.add('active');
    el.classList.add('active');
}
function changeMonth(dir) { curMonth.setMonth(curMonth.getMonth() + dir); renderAll(); }

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const y = curMonth.getFullYear(), m = curMonth.getMonth();
    document.getElementById('monthTitle').innerText = `${y}å¹´ ${m + 1}æœˆ`;
    grid.innerHTML = "";
    const firstDay = new Date(y, m, 1).getDay();
    const daysInM = new Date(y, m + 1, 0).getDate();
    for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';
    for (let d = 1; d <= daysInM; d++) {
        const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const daySites = db.sites.filter(s => s.date === dStr);
        let html = `<div class="day-card" onclick="openDayModal('${dStr}')"><b style="color:${db.ui.date}">${d}</b>`;
        daySites.forEach(s => html += `<div class="site-tag" style="background:${s.color}">${s.name}</div>`);
        grid.innerHTML += html + `</div>`;
    }
}

function renderWorkerList() {
    const list = document.getElementById('workerList');
    const q = document.getElementById('workerSearch').value.toLowerCase();
    const ym = `${curMonth.getFullYear()}-${String(curMonth.getMonth() + 1).padStart(2, '0')}`;
    list.innerHTML = ""; let totalAll = 0;
    
    db.workers.slice().sort((a,b)=>(b.isTop?1:0)-(a.isTop?1:0)).filter(w => w.name.includes(q)).forEach(w => {
        const sites = db.sites.filter(s => s.date.startsWith(ym) && s.workerIds.includes(w.id));
        const exs = db.extras.filter(e => e.workerId === w.id && e.date.startsWith(ym));
        const sub = (sites.length * Number(w.rate)) + exs.reduce((a,b)=>a+Number(b.amount), 0);
        totalAll += sub;
        list.innerHTML += `<div class="card" onclick="openWorkerModal('${w.id}')">
            <div class="row-between"><b>${w.isTop?'â­':''}${w.name}</b><span>${sites.length}å¤© / <span class="text-red">$${sub}</span></span></div>
        </div>`;
    });
    document.getElementById('totalExp').innerText = `$${totalAll}`;
    const p = db.payments[ym];
    document.getElementById('payStatusLabel').innerText = (p && p.done) ? "âœ… å·²å®Œæˆè«‹æ¬¾" : "";
}

// --- å½ˆçª—æ¨¡çµ„ ---
function showModal(h) { document.getElementById('modalBody').innerHTML = h; document.getElementById('modalOverlay').style.display = 'flex'; }
function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

function openDayModal(date) {
    const sites = db.sites.filter(s => s.date === date);
    let h = `<h3>ğŸ“… ${date}</h3>`;
    sites.forEach(s => h += `<button class="btn btn-blue full-width" style="background:${s.color}" onclick="openSiteEdit('${s.id}','${date}')">âœï¸ ${s.name}</button>`);
    h += `<hr><button class="btn btn-blue full-width" onclick="openSiteEdit(null,'${date}')">+ æ–°å¢æ¡ˆå ´</button>`;
    showModal(h);
}

function openSiteEdit(id, date) {
    const s = db.sites.find(x => x.id === id) || { id: "s"+Date.now(), name: "", color: "#007aff", workerIds: [] };
    let h = `<h3>æ¡ˆå ´ç·¨è¼¯</h3><input id="sName" class="input-f" value="${s.name}" placeholder="æ¡ˆå ´åç¨±">`;
    h += `<div class="row-between">é¡è‰² <input type="color" id="sColor" value="${s.color}"></div>`;
    h += `<div id="swList" style="max-height:200px; overflow-y:auto">`;
    db.workers.forEach(w => {
        h += `<div class="row-between"><span>${w.name}</span><input type="checkbox" class="site-ck" value="${w.id}" ${s.workerIds.includes(w.id)?'checked':''}></div>`;
    });
    h += `</div><button class="btn btn-blue full-width" onclick="saveSite('${s.id}','${date}')">å„²å­˜</button>`;
    if (id) h += `<button class="btn btn-red full-width" onclick="deleteItem('sites','${id}')">åˆªé™¤</button>`;
    showModal(h);
}

function openWorkerModal(id) {
    const isNew = !id;
    const w = db.workers.find(x => x.id === id) || { id: "w"+Date.now(), name: "", rate: 0, phone: "", note: "", isTop: false };
    const ym = `${curMonth.getFullYear()}-${String(curMonth.getMonth() + 1).padStart(2, '0')}`;
    let h = `<h3>${isNew?'æ–°å¢':'ç·¨è¼¯'}å¸«å‚…</h3>`;
    h += `<div class="row-between">ç½®é ‚ â­ <input type="checkbox" id="wTop" ${w.isTop?'checked':''}></div>`;
    h += `<input id="wName" class="input-f" value="${w.name}" placeholder="å§“å">`;
    h += `<input id="wRate" type="number" class="input-f" value="${w.rate}" placeholder="æ—¥è–ª">`;
    
    if (!isNew) {
        const sites = db.sites.filter(s => s.date.startsWith(ym) && s.workerIds.includes(w.id));
        const exs = db.extras.filter(e => e.workerId === w.id && e.date.startsWith(ym));
        const workDates = sites.map(s => parseInt(s.date.split('-')[2]) + "æ—¥").sort((a,b)=>a-b).join(", ");
        h += `<div class="card" style="background:#f9f9f9; font-size:14px;">
            <b>ğŸ“… ä¸Šå·¥æ—¥æœŸ (${ym})</b><br><span style="color:var(--blue)">${workDates || 'ç„¡'}</span><br>
            <b>ğŸ’° ç¸½è–ªè³‡ï¼š$${(sites.length * w.rate) + exs.reduce((a,b)=>a+Number(b.amount),0)}</b>
        </div>`;
    }
    h += `<button class="btn btn-blue full-width" onclick="saveWorker('${w.id}')">å„²å­˜å¸«å‚…</button>`;
    if(!isNew) h += `<button class="btn btn-red full-width" onclick="deleteWorker('${id}')">åˆªé™¤å¸«å‚…</button>`;
    showModal(h);
}

// --- è³‡æ–™å„²å­˜ ---
function saveSite(id, date) {
    const name = document.getElementById('sName').value;
    const wIds = Array.from(document.querySelectorAll('.site-ck:checked')).map(el => el.value);
    const idx = db.sites.findIndex(x => x.id === id);
    if (idx > -1) db.sites[idx] = { id, date, name, color: document.getElementById('sColor').value, workerIds: wIds };
    else db.sites.push({ id, date, name, color: document.getElementById('sColor').value, workerIds: wIds });
    closeModal(); renderAll(); syncCloud();
}
function saveWorker(id) {
    const name = document.getElementById('wName').value;
    const data = { id, name, rate: document.getElementById('wRate').value, isTop: document.getElementById('wTop').checked };
    const idx = db.workers.findIndex(x => x.id === id);
    if (idx > -1) db.workers[idx] = data; else db.workers.push(data);
    closeModal(); renderAll(); syncCloud();
}
function applyUI() {
    document.documentElement.style.setProperty('--bg', db.ui.bg);
    document.getElementById('weekLabels').style.color = db.ui.week;
}
function updateUI(k, v) { db.ui[k] = v; applyUI(); syncCloud(); }
function deleteWorker(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.workers = db.workers.filter(x=>x.id!==id); closeModal(); renderAll(); syncCloud(); } }
function deleteItem(type, id) { if(confirm("ç¢ºå®šï¼Ÿ")) { db[type] = db[type].filter(x=>x.id!==id); closeModal(); renderAll(); syncCloud(); } }
function masterReset() { if(confirm("âš ï¸ å…¨æ¸…ç©ºï¼Ÿ")) { localStorage.clear(); location.href=location.href.split('?')[0]; } }
</script>
</body>
</html>
